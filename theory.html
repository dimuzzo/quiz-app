<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software Application Development - Theory Quiz</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="quiz-style.css">
    <style>
        .language-switcher { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 10; }
        .language-switcher button { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        .language-switcher button:hover { background: rgba(255, 255, 255, 0.3); }
    </style>
</head>
<body>
<script src="i18n.js"></script>

<div class="container">
    <header class="header">
        <div class="language-switcher">
            <button onclick="i18n.setLanguage('it')">ITA</button>
            <button onclick="i18n.setLanguage('en')">ENG</button>
        </div>
        <h1 data-i18n-key="theory_page.title"></h1>
        <a href="index.html" class="back-link" data-i18n-key="global.back_to_home"></a>
    </header>
    <section class="progress-section" aria-live="polite">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-text-container">
            <span class="progress-text" id="progressText"></span>
            <div class="question-jump-section">
                <label for="questionJump" data-i18n-key="global.go_to" aria-label="Salta alla domanda"></label>
                <select id="questionJump"></select>
            </div>
        </div>
        <div id="questionMap" class="question-map" role="navigation" aria-label="Mappa delle domande"></div>
    </section>
    <main class="quiz-content" id="quizContent"></main>
    <footer class="controls">
        <button class="btn btn-secondary" id="prevBtn" data-i18n-key="global.previous"></button>
        <button class="btn btn-danger" id="stopBtn" data-i18n-key="global.stop_quiz"></button>
        <div class="current-stats">
            <span class="correct-count"><span data-i18n-key="global.correct"></span>: <span id="currentCorrectCount">0</span></span>
            <span class="incorrect-count"><span data-i18n-key="global.incorrect"></span>: <span id="currentIncorrectCount">0</span></span>
        </div>
        <div>
            <button class="btn btn-primary" id="showAnswerBtn" data-i18n-key="global.show_answer"></button>
            <button class="btn btn-primary hidden" id="nextBtn"></button>
        </div>
    </footer>

    <section class="results hidden" id="results" aria-live="assertive">
        <div class="score-circle" id="scoreCircle">
            <div class="score-inner">
                <div class="score-percentage" id="scorePercentage">0%</div>
                <div class="score-label" data-i18n-key="global.total_score"></div>
            </div>
        </div>
        <h2 data-i18n-key="global.quiz_finished"></h2>
        <p data-i18n-key="global.score_summary"></p>
        <div class="stats">
            <div class="stat" id="correctStat"><div class="stat-value">0</div><div class="stat-label" data-i18n-key="global.correct_total"></div></div>
            <div class="stat" id="incorrectStat"><div class="stat-value">0</div><div class="stat-label" data-i18n-key="global.incorrect_total"></div></div>
            <div class="stat" id="answeredCorrectStat"><div class="stat-value">0 / 0</div><div class="stat-label" data-i18n-key="global.correct_answered"></div></div>
            <div class="stat" id="answeredIncorrectStat"><div class="stat-value">0 / 0</div><div class="stat-label" data-i18n-key="global.incorrect_answered"></div></div>
        </div>
        <button class="btn btn-primary" id="restartBtn" data-i18n-key="global.restart_quiz"></button>
    </section>
</div>

<script src="quiz-logic.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    let quizInstance = null;

    function startQuiz() {
        const originalQuestions = i18n.getString('questions.theory');

        function renderTheoryQuestion(question, state) {
            const questionTitle = i18n.getString('theory_page.question_title', { number: state.currentQuestionIndex + 1 });
            return `<div class="question-card" data-question-id="${question.id}"><div class="question-number">${questionTitle}</div><div class="question-text">${question.text}</div><div class="options true-false"><div class="option" data-answer="true">${i18n.getString('global.true_option')}</div><div class="option" data-answer="false">${i18n.getString('global.false_option')}</div></div><div class="explanation hidden"><h4>${i18n.getString('global.explanation')}</h4><p>${question.explanation}</p></div></div>`;
        }

        function getQueryParam(param) {
            return new URLSearchParams(window.location.search).get(param);
        }
        
        let questionsToLoad = shuffleArray(originalQuestions);
        const numQuestionsRequestedStr = getQueryParam('numQuestions');

        if (numQuestionsRequestedStr && numQuestionsRequestedStr !== 'all') {
            const count = parseInt(numQuestionsRequestedStr, 10);
            if (!isNaN(count) && count > 0) {
                questionsToLoad = questionsToLoad.slice(0, count);
            }
        }
        quizInstance = initializeQuiz(questionsToLoad, renderTheoryQuestion);
    }

    document.addEventListener('languageChanged', () => {
        if (quizInstance) {
            const allNewQuestions = i18n.getString('questions.theory');
            // For theory quiz, we don't need to re-shuffle options, so no second argument.
            quizInstance.updateLanguage(allNewQuestions);
        }
    });

    if (i18n && i18n.strings && i18n.strings.global) {
        startQuiz();
    } else {
        document.addEventListener('languageChanged', startQuiz, { once: true });
    }
});
</script>
</body>
</html>